(function(e,t){if(typeof define==="function"&&define.amd){define([],t)}else if(typeof exports==="object"){module.exports=t()}else{e.YUVCanvas=t()}})(this,function(){function e(e){e=e||{};this.canvasElement=e.canvas||document.createElement("canvas");this.contextOptions=e.contextOptions;this.type=e.type||"yuv420";this.customYUV444=e.customYUV444;this.conversionType=e.conversionType||"rec601";this.width=e.width||640;this.height=e.height||320;this.animationTime=e.animationTime||0;this.canvasElement.width=this.width;this.canvasElement.height=this.height;this.initContextGL();if(this.contextGL){this.initProgram();this.initBuffers();this.initTextures()}if(this.type==="yuv420"){this.drawNextOuptutPictureGL=function(e){var t=this.contextGL;var r=this.texturePosBuffer;var a=this.uTexturePosBuffer;var i=this.vTexturePosBuffer;var o=this.yTextureRef;var n=this.uTextureRef;var u=this.vTextureRef;var s=e.yData;var v=e.uData;var f=e.vData;var h=this.width;var x=this.height;var T=e.yDataPerRow||h;var l=e.yRowCnt||x;var R=e.uDataPerRow||h/2;var c=e.uRowCnt||x/2;var A=e.vDataPerRow||R;var E=e.vRowCnt||c;t.viewport(0,0,h,x);var m=0;var g=0;var p=x/l;var d=h/T;var P=new Float32Array([d,m,g,m,d,p,g,p]);t.bindBuffer(t.ARRAY_BUFFER,r);t.bufferData(t.ARRAY_BUFFER,P,t.DYNAMIC_DRAW);if(this.customYUV444){p=x/c;d=h/R}else{p=x/2/c;d=h/2/R}var y=new Float32Array([d,m,g,m,d,p,g,p]);t.bindBuffer(t.ARRAY_BUFFER,a);t.bufferData(t.ARRAY_BUFFER,y,t.DYNAMIC_DRAW);if(this.customYUV444){p=x/E;d=h/A}else{p=x/2/E;d=h/2/A}var U=new Float32Array([d,m,g,m,d,p,g,p]);t.bindBuffer(t.ARRAY_BUFFER,i);t.bufferData(t.ARRAY_BUFFER,U,t.DYNAMIC_DRAW);t.activeTexture(t.TEXTURE0);t.bindTexture(t.TEXTURE_2D,o);t.texImage2D(t.TEXTURE_2D,0,t.LUMINANCE,T,l,0,t.LUMINANCE,t.UNSIGNED_BYTE,s);t.activeTexture(t.TEXTURE1);t.bindTexture(t.TEXTURE_2D,n);t.texImage2D(t.TEXTURE_2D,0,t.LUMINANCE,R,c,0,t.LUMINANCE,t.UNSIGNED_BYTE,v);t.activeTexture(t.TEXTURE2);t.bindTexture(t.TEXTURE_2D,u);t.texImage2D(t.TEXTURE_2D,0,t.LUMINANCE,A,E,0,t.LUMINANCE,t.UNSIGNED_BYTE,f);t.drawArrays(t.TRIANGLE_STRIP,0,4)}}else if(this.type==="yuv422"){this.drawNextOuptutPictureGL=function(e){var t=this.contextGL;var r=this.texturePosBuffer;var a=this.textureRef;var i=e.data;var o=this.width;var n=this.height;var u=e.dataPerRow||o*2;var s=e.rowCnt||n;t.viewport(0,0,o,n);var v=0;var f=0;var h=n/s;var x=o/(u/2);var T=new Float32Array([x,v,f,v,x,h,f,h]);t.bindBuffer(t.ARRAY_BUFFER,r);t.bufferData(t.ARRAY_BUFFER,T,t.DYNAMIC_DRAW);t.uniform2f(t.getUniformLocation(this.shaderProgram,"resolution"),u,n);t.activeTexture(t.TEXTURE0);t.bindTexture(t.TEXTURE_2D,a);t.texImage2D(t.TEXTURE_2D,0,t.LUMINANCE,u,s,0,t.LUMINANCE,t.UNSIGNED_BYTE,i);t.drawArrays(t.TRIANGLE_STRIP,0,4)}}}e.prototype.isWebGL=function(){return this.contextGL};e.prototype.initContextGL=function(){var e=this.canvasElement;var t=null;var r=["webgl","experimental-webgl","moz-webgl","webkit-3d"];var a=0;while(!t&&a<r.length){var i=r[a];try{if(this.contextOptions){t=e.getContext(i,this.contextOptions)}else{t=e.getContext(i)}}catch(e){t=null}if(!t||typeof t.getParameter!=="function"){t=null}++a}this.contextGL=t};e.prototype.initProgram=function(){var e=this.contextGL;var t;var r;if(this.type==="yuv420"){t=["attribute vec4 vertexPos;","attribute vec4 texturePos;","attribute vec4 uTexturePos;","attribute vec4 vTexturePos;","varying vec2 textureCoord;","varying vec2 uTextureCoord;","varying vec2 vTextureCoord;","void main()","{","  gl_Position = vertexPos;","  textureCoord = texturePos.xy;","  uTextureCoord = uTexturePos.xy;","  vTextureCoord = vTexturePos.xy;","}"].join("\n");r=["precision highp float;","varying highp vec2 textureCoord;","varying highp vec2 uTextureCoord;","varying highp vec2 vTextureCoord;","uniform sampler2D ySampler;","uniform sampler2D uSampler;","uniform sampler2D vSampler;","uniform mat4 YUV2RGB;","void main(void) {","  highp float y = texture2D(ySampler,  textureCoord).r;","  highp float u = texture2D(uSampler,  uTextureCoord).r;","  highp float v = texture2D(vSampler,  vTextureCoord).r;","  gl_FragColor = vec4(y, u, v, 1) * YUV2RGB;","}"].join("\n")}else if(this.type==="yuv422"){t=["attribute vec4 vertexPos;","attribute vec4 texturePos;","varying vec2 textureCoord;","void main()","{","  gl_Position = vertexPos;","  textureCoord = texturePos.xy;","}"].join("\n");r=["precision highp float;","varying highp vec2 textureCoord;","uniform sampler2D sampler;","uniform highp vec2 resolution;","uniform mat4 YUV2RGB;","void main(void) {","  highp float texPixX = 1.0 / resolution.x;","  highp float logPixX = 2.0 / resolution.x;","  highp float logHalfPixX = 4.0 / resolution.x;","  highp float steps = floor(textureCoord.x / logPixX);","  highp float uvSteps = floor(textureCoord.x / logHalfPixX);","  highp float y = texture2D(sampler, vec2((logPixX * steps) + texPixX, textureCoord.y)).r;","  highp float u = texture2D(sampler, vec2((logHalfPixX * uvSteps), textureCoord.y)).r;","  highp float v = texture2D(sampler, vec2((logHalfPixX * uvSteps) + texPixX + texPixX, textureCoord.y)).r;","  gl_FragColor = vec4(y, u, v, 1.0) * YUV2RGB;","}"].join("\n")}var a=[];if(this.conversionType=="rec709"){a=[1.16438,0,1.79274,-.97295,1.16438,-.21325,-.53291,.30148,1.16438,2.1124,0,-1.1334,0,0,0,1]}else{a=[1.16438,0,1.59603,-.87079,1.16438,-.39176,-.81297,.52959,1.16438,2.01723,0,-1.08139,0,0,0,1]}var i=e.createShader(e.VERTEX_SHADER);e.shaderSource(i,t);e.compileShader(i);if(!e.getShaderParameter(i,e.COMPILE_STATUS)){console.log("Vertex shader failed to compile: "+e.getShaderInfoLog(i))}var o=e.createShader(e.FRAGMENT_SHADER);e.shaderSource(o,r);e.compileShader(o);if(!e.getShaderParameter(o,e.COMPILE_STATUS)){console.log("Fragment shader failed to compile: "+e.getShaderInfoLog(o))}var n=e.createProgram();e.attachShader(n,i);e.attachShader(n,o);e.linkProgram(n);if(!e.getProgramParameter(n,e.LINK_STATUS)){console.log("Program failed to compile: "+e.getProgramInfoLog(n))}e.useProgram(n);var u=e.getUniformLocation(n,"YUV2RGB");e.uniformMatrix4fv(u,false,a);this.shaderProgram=n};e.prototype.initBuffers=function(){var e=this.contextGL;var t=this.shaderProgram;var r=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,r);e.bufferData(e.ARRAY_BUFFER,new Float32Array([1,1,-1,1,1,-1,-1,-1]),e.STATIC_DRAW);var a=e.getAttribLocation(t,"vertexPos");e.enableVertexAttribArray(a);e.vertexAttribPointer(a,2,e.FLOAT,false,0,0);if(this.animationTime){var i=this.animationTime;var o=0;var n=15;var u=function(){o+=n;var r=1*o/i;if(o>=i){r=1}else{setTimeout(u,n)}var a=-1*r;var s=1*r;var v=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,v);e.bufferData(e.ARRAY_BUFFER,new Float32Array([s,s,a,s,s,a,a,a]),e.STATIC_DRAW);var f=e.getAttribLocation(t,"vertexPos");e.enableVertexAttribArray(f);e.vertexAttribPointer(f,2,e.FLOAT,false,0,0);try{e.drawArrays(e.TRIANGLE_STRIP,0,4)}catch(e){}};u()}var s=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,s);e.bufferData(e.ARRAY_BUFFER,new Float32Array([1,0,0,0,1,1,0,1]),e.STATIC_DRAW);var v=e.getAttribLocation(t,"texturePos");e.enableVertexAttribArray(v);e.vertexAttribPointer(v,2,e.FLOAT,false,0,0);this.texturePosBuffer=s;if(this.type==="yuv420"){var f=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,f);e.bufferData(e.ARRAY_BUFFER,new Float32Array([1,0,0,0,1,1,0,1]),e.STATIC_DRAW);var h=e.getAttribLocation(t,"uTexturePos");e.enableVertexAttribArray(h);e.vertexAttribPointer(h,2,e.FLOAT,false,0,0);this.uTexturePosBuffer=f;var x=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,x);e.bufferData(e.ARRAY_BUFFER,new Float32Array([1,0,0,0,1,1,0,1]),e.STATIC_DRAW);var T=e.getAttribLocation(t,"vTexturePos");e.enableVertexAttribArray(T);e.vertexAttribPointer(T,2,e.FLOAT,false,0,0);this.vTexturePosBuffer=x}};e.prototype.initTextures=function(){var e=this.contextGL;var t=this.shaderProgram;if(this.type==="yuv420"){var r=this.initTexture();var a=e.getUniformLocation(t,"ySampler");e.uniform1i(a,0);this.yTextureRef=r;var i=this.initTexture();var o=e.getUniformLocation(t,"uSampler");e.uniform1i(o,1);this.uTextureRef=i;var n=this.initTexture();var u=e.getUniformLocation(t,"vSampler");e.uniform1i(u,2);this.vTextureRef=n}else if(this.type==="yuv422"){var s=this.initTexture();var v=e.getUniformLocation(t,"sampler");e.uniform1i(v,0);this.textureRef=s}};e.prototype.initTexture=function(){var e=this.contextGL;var t=e.createTexture();e.bindTexture(e.TEXTURE_2D,t);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);e.bindTexture(e.TEXTURE_2D,null);return t};e.prototype.drawNextOutputPicture=function(e,t,r,a){var i=this.contextGL;if(i){this.drawNextOuptutPictureGL(e,t,r,a)}else{this.drawNextOuptutPictureRGBA(e,t,r,a)}};e.prototype.drawNextOuptutPictureRGBA=function(e,t,r,a){var i=this.canvasElement;var r=null;var o=a;var n=i.getContext("2d");var u=n.getImageData(0,0,e,t);u.data.set(o);if(r===null){n.putImageData(u,0,0)}else{n.putImageData(u,-r.left,-r.top,0,0,r.width,r.height)}};return e});